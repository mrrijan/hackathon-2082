<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>StudyBrain AI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:'Inter',sans-serif;
    background: radial-gradient(circle at top,#0f172a,#020617);
    color:white;
    display:flex;
    justify-content:center;
}

.topbar{
    position:fixed;
    top:15px;
    left:20px;
}

.topbar button{
    margin-right:10px;
}

.container{
    width:900px;
    margin-top:80px;
}

h1{
    text-align:center;
    font-size:48px;
    background:linear-gradient(90deg,#38bdf8,#a78bfa);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

.subtitle{
    text-align:center;
    color:#94a3b8;
    margin-bottom:40px;
}

.card{
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.1);
    backdrop-filter:blur(10px);
    border-radius:20px;
    padding:30px;
    margin-bottom:25px;
}

.upload-box{
    border:2px dashed rgba(255,255,255,0.2);
    padding:40px;
    text-align:center;
    border-radius:15px;
    cursor:pointer;
}

.upload-box:hover{
    border-color:#38bdf8;
}

button{
    padding:12px 24px;
    border:none;
    border-radius:12px;
    font-weight:600;
    cursor:pointer;
    background:linear-gradient(90deg,#38bdf8,#a78bfa);
    color:white;
}

video{
    width:100%;
    margin-top:20px;
    border-radius:15px;
}

.loading{
    text-align:center;
    display:none;
}
</style>
</head>

<body>

<!-- TOP LEFT BUTTONS -->
<div class="topbar">
    <button onclick="openHistory()">ðŸ“Š History</button>
    <button onclick="clearHistory()" style="background:#ef4444;">ðŸ—‘ Clear</button>
</div>

<div class="container">

<h1>StudyBrain AI</h1>
<div class="subtitle">Turn your notes into smart summaries & viral study videos</div>

<div class="card">
    <div class="upload-box" onclick="document.getElementById('pdfInput').click()">
        ðŸ“„ Drop PDF here or click to upload
        <input type="file" id="pdfInput" accept=".pdf" hidden>
    </div>

    <center>
        <button style="margin-top : 10px;" onclick="uploadPDF()">Generate Smart Notes</button>
    </center>

    <div class="loading" id="loadingNotes">
        <p>Reading PDF...</p>
    </div>
</div>

<div class="card" id="notesCard" style="display:none;">
    <h3>ðŸ“š Smart Notes</h3>
    <div id="notesResult"></div>

    <div style="display:flex;gap:20px;margin-top:20px;">
        <button onclick="generateVideo()">ðŸŽ¬ Brain Mode</button>
        <button onclick="generateDream()">ðŸŒ™ Sleep Mode</button>
    </div>

    <div class="loading" id="loadingVideo">Generating video...</div>
    <div class="loading" id="loadingDream">Generating sleep mode...</div>

    <video id="videoPlayer" controls style="display:none;"></video>
    <audio id="audioPlayer" controls style="display:none;width:100%;margin-top:20px;"></audio>

    <div id="quizSection" style="display:none;margin-top:30px;"></div>
</div>

</div>

<!-- HISTORY MODAL -->
<div id="historyModal" style="
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.9);
overflow:auto;
padding:40px;
z-index:999;
">
<div style="max-width:800px;margin:auto;background:#020617;padding:30px;border-radius:20px;">
<h2>ðŸ“š Learning History</h2>
<div id="historyContent"></div>
<button onclick="closeHistory()">Close</button>
</div>
</div>

<script>
let latestNotesText="";
let currentTopic="";
let currentVideoURL="";

async function uploadPDF(){
    const file=document.getElementById('pdfInput').files[0];
    if(!file) return alert("Upload a PDF first");

    // CLEAR CURRENT SESSION DISPLAY
    document.getElementById("notesResult").innerHTML="";
    document.getElementById("videoPlayer").style.display="none";
    document.getElementById("audioPlayer").style.display="none";
    document.getElementById("quizSection").style.display="none";
    document.getElementById("notesCard").style.display="none";

    latestNotesText="";
    currentTopic="";
    currentVideoURL="";

    document.getElementById("loadingNotes").style.display="block";

    const formData=new FormData();
    formData.append("file",file);

    const res=await fetch("http://127.0.0.1:8000/process-pdf",{
        method:"POST",
        body:formData
    });

    const data=await res.json();

    document.getElementById("loadingNotes").style.display="none";
    document.getElementById("notesCard").style.display="block";

    latestNotesText=data.result;
    currentTopic=data.result.split("\n")[0].substring(0,60);

    document.getElementById("notesResult").innerHTML=data.result.replace(/\n/g,"<br>");
}

async function generateVideo(){
    if(!latestNotesText) return alert("Generate notes first");

    document.getElementById("quizSection").style.display="none";
    document.getElementById("loadingVideo").style.display="block";

    const formData=new FormData();
    formData.append("text",latestNotesText);

    const res=await fetch("http://127.0.0.1:8000/generate-video",{
        method:"POST",
        body:formData
    });

    const blob=await res.blob();
    const url=URL.createObjectURL(blob);

    currentVideoURL=url;

    document.getElementById("loadingVideo").style.display="none";

    const player=document.getElementById("videoPlayer");
    player.src=url;
    player.style.display="block";

    player.onended=async()=>{await generateQuiz();}
}

async function generateDream(){
    if(!latestNotesText) return alert("Generate notes first");

    document.getElementById("loadingDream").style.display="block";

    const formData=new FormData();
    formData.append("text",latestNotesText);

    const res=await fetch("http://127.0.0.1:8000/generate-dream-audio",{
        method:"POST",
        body:formData
    });

    const blob=await res.blob();
    const url=URL.createObjectURL(blob);

    document.getElementById("loadingDream").style.display="none";

    const player=document.getElementById("audioPlayer");
    player.src=url;
    player.style.display="block";
}

async function generateQuiz(){
    const formData=new FormData();
    formData.append("text",latestNotesText);

    const res=await fetch("http://127.0.0.1:8000/generate-quiz",{
        method:"POST",
        body:formData
    });

    const data=await res.json();
    renderQuiz(data.quiz);
}

function renderQuiz(quiz){
    const container=document.getElementById("quizSection");
    container.innerHTML="<h3>ðŸ§  Quick Challenge</h3>";
    container.style.display="block";

    quiz.forEach((q,index)=>{
        container.innerHTML+=`
        <p><strong>Q${index+1}:</strong> ${q.question}</p>
        ${q.options.map((opt,i)=>`
        <label>
        <input type="radio" name="q${index}" value="${i}">
        ${opt}
        </label><br>
        `).join("")}
        <br>
        `;
    });

    container.innerHTML+=`
    <button onclick="submitQuiz()">Submit</button>
    <div id="quizResult"></div>
    `;

    window.currentQuiz=quiz;
}

function submitQuiz(){
    let score=0;
    const quiz=window.currentQuiz;

    quiz.forEach((q,index)=>{
        const selected=document.querySelector(`input[name="q${index}"]:checked`);
        if(selected && parseInt(selected.value)===q.answer_index){
            score++;
        }
    });

    const percentage=Math.round((score/quiz.length)*100);

    saveToHistory(percentage);

    document.getElementById("quizResult").innerHTML=
    `<h3>Score: ${percentage}%</h3>`;
}

function saveToHistory(score){
    const history=JSON.parse(localStorage.getItem("studyHistory"))||[];

    history.unshift({
        topic:currentTopic,
        score:score,
        video:currentVideoURL,
        date:new Date().toLocaleString()
    });

    localStorage.setItem("studyHistory",JSON.stringify(history));
}

function openHistory(){
    const history=JSON.parse(localStorage.getItem("studyHistory"))||[];
    const container=document.getElementById("historyContent");

    container.innerHTML="";

    history.forEach(h=>{
        container.innerHTML+=`
        <div style="margin-bottom:20px;border:1px solid #334155;padding:15px;border-radius:12px;">
        <strong>${h.topic}</strong><br>
        Score: ${h.score}%<br>
        Date: ${h.date}<br>
        ${h.video ? `<video src="${h.video}" controls style="width:100%;margin-top:10px;"></video>` : ""}
        </div>
        `;
    });

    document.getElementById("historyModal").style.display="block";
}

function closeHistory(){
    document.getElementById("historyModal").style.display="none";
}

function clearHistory(){
    if(confirm("Delete history?")){
        localStorage.removeItem("studyHistory");
        alert("History cleared");
    }
}
</script>

</body>
</html>